<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Builder | AI-Automation.gr</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #0f1923 0%, #1a2332 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }

        /* Header */
        .header {
            background: rgba(15, 25, 35, 0.95);
            border-bottom: 1px solid rgba(6, 182, 212, 0.3);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 700;
            color: #06b6d4;
        }

        .logo-icon {
            font-size: 28px;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-icon {
            position: relative;
            z-index: 1;
        }

        .btn span {
            position: relative;
            z-index: 1;
        }

        .btn-cyan {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
        }

        .btn-cyan:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(6, 182, 212, 0.6);
        }

        .btn-green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-green:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
        }

        .btn-pink {
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
        }

        .btn-pink:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(236, 72, 153, 0.6);
        }

        .btn-blue {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-blue:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
        }

        .btn-orange {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }

        .btn-orange:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.6);
        }

        .btn-dark {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(6, 182, 212, 0.3);
            color: #06b6d4;
        }

        .btn-dark:hover {
            background: rgba(30, 41, 59, 1);
            border-color: #06b6d4;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Main Layout */
        .container {
            display: grid;
            grid-template-columns: 280px 1fr 280px;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 70px);
        }

        /* Panels */
        .panel {
            background: rgba(15, 25, 35, 0.8);
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            overflow-y: auto;
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(6, 182, 212, 0.2);
        }

        .panel-icon {
            font-size: 24px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 700;
            color: #06b6d4;
        }

        /* Components Library */
        .component-library {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .component-item {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 10px;
            padding: 12px;
            cursor: grab;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .component-item:hover {
            background: rgba(30, 41, 59, 0.9);
            border-color: #06b6d4;
            transform: translateX(5px);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
        }

        .component-item:active {
            cursor: grabbing;
        }

        .component-icon {
            font-size: 28px;
            filter: drop-shadow(0 0 5px rgba(6, 182, 212, 0.5));
        }

        .component-info {
            flex: 1;
        }

        .component-name {
            font-weight: 600;
            color: #e2e8f0;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .component-desc {
            font-size: 11px;
            color: #94a3b8;
        }

        /* Workspace */
        .workspace {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .workspace-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .canvas-container {
            flex: 1;
            background: rgba(15, 25, 35, 0.8);
            border: 2px dashed rgba(6, 182, 212, 0.3);
            border-radius: 12px;
            position: relative;
            overflow: auto;
            min-height: 400px;
        }

        .canvas-container.drag-over {
            border-color: #06b6d4;
            background: rgba(6, 182, 212, 0.05);
            box-shadow: inset 0 0 30px rgba(6, 182, 212, 0.2);
        }

        .canvas-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #64748b;
            pointer-events: none;
        }

        .canvas-placeholder-icon {
            font-size: 64px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .canvas-placeholder-text {
            font-size: 16px;
            font-weight: 500;
        }

        .status-message {
            background: rgba(30, 41, 59, 0.8);
            border-left: 3px solid #06b6d4;
            padding: 12px 15px;
            border-radius: 6px;
            color: #94a3b8;
            font-size: 13px;
        }

        /* Placed Components */
        .placed-component {
            position: absolute;
            background: rgba(15, 25, 35, 0.95);
            border: 2px solid rgba(6, 182, 212, 0.5);
            border-radius: 12px;
            padding: 15px;
            cursor: move;
            min-width: 130px;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .placed-component:hover {
            border-color: #06b6d4;
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.5);
            transform: scale(1.05);
        }

        .placed-component.active {
            border-color: #10b981;
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.6);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 30px rgba(16, 185, 129, 0.6); }
            50% { box-shadow: 0 0 40px rgba(16, 185, 129, 0.8); }
        }

        .placed-icon {
            font-size: 36px;
            text-align: center;
            margin-bottom: 8px;
            filter: drop-shadow(0 0 8px rgba(6, 182, 212, 0.6));
        }

        .placed-name {
            font-weight: 600;
            color: #e2e8f0;
            text-align: center;
            font-size: 13px;
            margin-bottom: 6px;
        }

        .placed-value {
            text-align: center;
            color: #06b6d4;
            font-weight: 700;
            font-size: 18px;
            text-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
        }

        .component-remove {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: 2px solid rgba(15, 25, 35, 1);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
        }

        .component-remove:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.8);
        }

        /* Statistics */
        .stat-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #94a3b8;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #06b6d4;
            text-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
        }

        /* Scenarios */
        .scenarios {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .scenario-btn {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .scenario-btn:hover {
            background: rgba(30, 41, 59, 0.9);
            border-color: #06b6d4;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
            transform: translateX(5px);
        }

        .scenario-icon {
            font-size: 24px;
        }

        .scenario-info {
            flex: 1;
        }

        .scenario-name {
            font-weight: 600;
            color: #e2e8f0;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .scenario-desc {
            font-size: 11px;
            color: #94a3b8;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a2332 0%, #0f1923 100%);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 100px rgba(6, 182, 212, 0.2);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #ef4444;
            border-radius: 8px;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
            transform: rotate(90deg);
        }

        .modal h2 {
            color: #06b6d4;
            margin-bottom: 25px;
            font-size: 24px;
            text-shadow: 0 0 10px rgba(6, 182, 212, 0.3);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #e2e8f0;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.3);
            background: rgba(30, 41, 59, 0.8);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .modal-actions .btn {
            flex: 1;
        }

        /* Auth Tabs */
        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(6, 182, 212, 0.2);
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s;
            position: relative;
        }

        .auth-tab.active {
            color: #06b6d4;
        }

        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #06b6d4, #10b981);
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        /* User Info */
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 15px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 8px;
        }

        .user-email {
            color: #e2e8f0;
            font-weight: 600;
            font-size: 14px;
        }

        .user-role {
            padding: 4px 10px;
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
            color: white;
            border-radius: 5px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            box-shadow: 0 0 10px rgba(236, 72, 153, 0.4);
        }

        /* Project List */
        .project-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 500px;
            overflow-y: auto;
        }

        .project-item {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s;
        }

        .project-item:hover {
            background: rgba(30, 41, 59, 0.9);
            border-color: #06b6d4;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .project-name {
            font-weight: 600;
            color: #e2e8f0;
            font-size: 16px;
        }

        .project-actions {
            display: flex;
            gap: 6px;
        }

        .project-actions .btn {
            padding: 6px 12px;
            font-size: 12px;
        }

        .project-desc {
            color: #94a3b8;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .project-meta {
            display: flex;
            gap: 15px;
            font-size: 11px;
            color: #64748b;
        }

        /* Alerts */
        .alert {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            border-left: 3px solid;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
            color: #6ee7b7;
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #fca5a5;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: #f59e0b;
            color: #fcd34d;
        }

        .alert-info {
            background: rgba(6, 182, 212, 0.1);
            border-color: #06b6d4;
            color: #67e8f9;
        }

        /* Footer */
        .footer {
            background: rgba(15, 25, 35, 0.95);
            border-top: 1px solid rgba(6, 182, 212, 0.3);
            padding: 15px 30px;
            text-align: center;
            color: #64748b;
            font-size: 13px;
        }

        .footer a {
            color: #06b6d4;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }

        .footer a:hover {
            color: #10b981;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-top-color: #06b6d4;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #06b6d4 0%, #10b981 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #0891b2 0%, #059669 100%);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }

            .panel:first-child,
            .panel:last-child {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 12px;
            }

            .header-controls {
                width: 100%;
                justify-content: center;
            }

            .workspace-controls {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <span class="logo-icon">âš¡</span>
            <span id="headerTitle">IoT Builder</span>
        </div>
        
        <div class="header-controls">
            <!-- Language Toggle -->
            <button class="btn btn-dark" id="langToggle" onclick="toggleLanguage()">
                <span class="btn-icon">ğŸŒ</span>
                <span id="langText">Î•Î»Î»Î·Î½Î¹ÎºÎ¬</span>
            </button>

            <!-- User Section -->
            <div id="userSection" style="display: none;">
                <div class="user-info">
                    <span class="user-email" id="userEmail"></span>
                    <span class="user-role" id="userRole"></span>
                    <button class="btn btn-dark" onclick="logout()">
                        <span id="logoutText">Logout</span>
                    </button>
                </div>
            </div>

            <!-- Auth Button -->
            <button class="btn btn-cyan" id="authBtn" onclick="openAuthModal()">
                <span class="btn-icon">ğŸ”</span>
                <span id="authBtnText">Sign In</span>
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Left Panel: Components -->
        <div class="panel">
            <div class="panel-header">
                <span class="panel-icon">ğŸ“¦</span>
                <h2 class="panel-title" id="componentsTitle">Components</h2>
            </div>
            <div class="component-library" id="componentLibrary">
                <!-- Components will be populated by JavaScript -->
            </div>
        </div>

        <!-- Center: Workspace -->
        <div class="workspace">
            <div class="workspace-controls">
                <button class="btn btn-green" id="simulateBtn" onclick="toggleSimulation()">
                    <span class="btn-icon">â–¶ï¸</span>
                    <span id="simulateBtnText">Start</span>
                </button>
                <button class="btn btn-pink" id="stopBtn" onclick="toggleSimulation()" style="display: none;">
                    <span class="btn-icon">â¹ï¸</span>
                    <span id="stopBtnText">Stop</span>
                </button>
                <button class="btn btn-blue" onclick="openSaveModal()">
                    <span class="btn-icon">ğŸ’¾</span>
                    <span id="saveBtnText">Save</span>
                </button>
                <button class="btn btn-blue" onclick="openLoadModal()">
                    <span class="btn-icon">ğŸ“‚</span>
                    <span id="loadBtnText">Load</span>
                </button>
                <button class="btn btn-orange" onclick="exportToPNG()">
                    <span class="btn-icon">ğŸ“¸</span>
                    <span id="exportBtnText">Export PNG</span>
                </button>
                <button class="btn btn-dark" onclick="clearCanvas()">
                    <span class="btn-icon">ğŸ—‘ï¸</span>
                    <span id="clearBtnText">Clear</span>
                </button>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <span class="panel-icon">ğŸ’¡</span>
                    <h2 class="panel-title" id="workspaceTitle">Workspace</h2>
                </div>
                <div class="canvas-container" id="canvas" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <div class="canvas-placeholder" id="canvasPlaceholder">
                        <div class="canvas-placeholder-icon">ğŸ¯</div>
                        <div class="canvas-placeholder-text" id="placeholderText">Drag components here</div>
                    </div>
                </div>
                <div class="status-message" id="statusMessage">
                    <span id="statusText">Ready. Sign in to save projects.</span>
                </div>
            </div>
        </div>

        <!-- Right Panel: Statistics & Scenarios -->
        <div class="panel">
            <div class="panel-header">
                <span class="panel-icon">ğŸ“Š</span>
                <h2 class="panel-title" id="statsTitle">Statistics</h2>
            </div>
            
            <div class="stat-card">
                <div class="stat-label" id="componentsLabel">COMPONENTS</div>
                <div class="stat-value" id="componentsCount">0</div>
            </div>

            <div class="stat-card">
                <div class="stat-label" id="connectionsLabel">CONNECTIONS</div>
                <div class="stat-value" id="connectionsCount">0</div>
            </div>

            <div class="stat-card">
                <div class="stat-label" id="dataSecLabel">DATA/SEC</div>
                <div class="stat-value" id="dataSecCount">0</div>
            </div>

            <div class="panel-header" style="margin-top: 30px;">
                <span class="panel-icon">ğŸ¯</span>
                <h2 class="panel-title" id="scenariosTitle">Scenarios</h2>
            </div>

            <div class="scenarios">
                <button class="scenario-btn" onclick="loadScenario('warehouse')">
                    <span class="scenario-icon">ğŸ­</span>
                    <div class="scenario-info">
                        <div class="scenario-name" id="scenario1Name">Warehouse Monitor</div>
                        <div class="scenario-desc" id="scenario1Desc">PLC + Sensors + Gateway</div>
                    </div>
                </button>
                <button class="scenario-btn" onclick="loadScenario('temperature')">
                    <span class="scenario-icon">ğŸŒ¡ï¸</span>
                    <div class="scenario-info">
                        <div class="scenario-name" id="scenario2Name">Temperature Control</div>
                        <div class="scenario-desc" id="scenario2Desc">Sensors + Actuators + Alarm</div>
                    </div>
                </button>
                <button class="scenario-btn" onclick="loadScenario('inventory')">
                    <span class="scenario-icon">ğŸ“¦</span>
                    <div class="scenario-info">
                        <div class="scenario-name" id="scenario3Name">Inventory Tracking</div>
                        <div class="scenario-desc" id="scenario3Desc">Motion + PLC + Gateway</div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        Built for <a href="https://ai-automation.gr" target="_blank">AI-Automation.gr</a> | Industrial IoT & Automation Solutions
    </div>

    <!-- Auth Modal -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeAuthModal()">Ã—</button>
            <h2 id="authModalTitle">Authentication</h2>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')" id="loginTab">Login</button>
                <button class="auth-tab" onclick="switchAuthTab('signup')" id="signupTab">Sign Up</button>
            </div>

            <!-- Login Form -->
            <div class="auth-form active" id="loginForm">
                <div class="form-group">
                    <label id="emailLabel1">Email</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label id="passwordLabel1">Password</label>
                    <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-cyan" onclick="handleLogin()">
                        <span id="loginSubmitText">Login</span>
                    </button>
                </div>
            </div>

            <!-- Signup Form -->
            <div class="auth-form" id="signupForm">
                <div class="form-group">
                    <label id="emailLabel2">Email</label>
                    <input type="email" id="signupEmail" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label id="passwordLabel2">Password</label>
                    <input type="password" id="signupPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>
                <div class="form-group">
                    <label id="fullNameLabel">Full Name</label>
                    <input type="text" id="signupFullName" placeholder="John Doe" required>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-green" onclick="handleSignup()">
                        <span id="signupSubmitText">Create Account</span>
                    </button>
                </div>
            </div>

            <div id="authAlert" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Save Project Modal -->
    <div class="modal" id="saveModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeSaveModal()">Ã—</button>
            <h2 id="saveModalTitle">Save Project</h2>

            <div class="form-group">
                <label id="projectNameLabel">Project Name</label>
                <input type="text" id="projectName" placeholder="My IoT Project" required>
            </div>
            <div class="form-group">
                <label id="projectDescLabel">Description (optional)</label>
                <textarea id="projectDesc" placeholder="Describe your IoT setup..."></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn btn-dark" onclick="closeSaveModal()">
                    <span id="saveCancelText">Cancel</span>
                </button>
                <button class="btn btn-cyan" onclick="saveProject()">
                    <span class="btn-icon">ğŸ’¾</span>
                    <span id="saveConfirmText">Save</span>
                </button>
            </div>

            <div id="saveAlert" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Load Project Modal -->
    <div class="modal" id="loadModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeLoadModal()">Ã—</button>
            <h2 id="loadModalTitle">Load Project</h2>

            <div id="projectList" class="project-list">
                <!-- Projects will be populated by JavaScript -->
            </div>

            <div id="loadAlert" style="margin-top: 15px;"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // ==================== CONFIGURATION ====================
        const API_URL = 'https://iot-simulator-backend.onrender.com';
        
        let currentUser = null;
        let authToken = null;
        let placedComponents = [];
        let simulationRunning = false;
        let simulationInterval = null;
        let componentCounter = 0;
        let currentProjectId = null;
        let currentLang = 'en';
        let dataPerSec = 0;

        // ==================== COMPONENT DEFINITIONS ====================
        const componentTypes = {
            en: [
                { id: 'temp-sensor', icon: 'ğŸŒ¡ï¸', name: 'Temperature Sensor', desc: 'Monitors temperature', type: 'sensor', unit: 'Â°C' },
                { id: 'humidity-sensor', icon: 'ğŸ’§', name: 'Humidity Sensor', desc: 'Monitors humidity', type: 'sensor', unit: '%' },
                { id: 'motion-sensor', icon: 'ğŸ‘ï¸', name: 'Motion Detector', desc: 'Detects movement', type: 'sensor', unit: '' },
                { id: 'plc', icon: 'ğŸ–¥ï¸', name: 'PLC Controller', desc: 'Siemens S7-1200', type: 'controller', unit: '' },
                { id: 'gateway', icon: 'ğŸ“¡', name: 'IoT Gateway', desc: 'MQTT/Modbus', type: 'gateway', unit: '' },
                { id: 'motor', icon: 'âš™ï¸', name: 'Motor/Actuator', desc: 'Controls movement', type: 'actuator', unit: 'RPM' },
                { id: 'valve', icon: 'ğŸ”§', name: 'Valve', desc: 'Flow control', type: 'actuator', unit: '%' },
                { id: 'alarm', icon: 'ğŸš¨', name: 'Alarm System', desc: 'Alert notifications', type: 'output', unit: '' }
            ],
            gr: [
                { id: 'temp-sensor', icon: 'ğŸŒ¡ï¸', name: 'Î‘Î¹ÏƒÎ¸Î·Ï„Î®ÏÎ±Ï‚ Î˜ÎµÏÎ¼Î¿ÎºÏÎ±ÏƒÎ¯Î±Ï‚', desc: 'ÎœÎµÏ„ÏÎ¬ Î¸ÎµÏÎ¼Î¿ÎºÏÎ±ÏƒÎ¯Î±', type: 'sensor', unit: 'Â°C' },
                { id: 'humidity-sensor', icon: 'ğŸ’§', name: 'Î‘Î¹ÏƒÎ¸Î·Ï„Î®ÏÎ±Ï‚ Î¥Î³ÏÎ±ÏƒÎ¯Î±Ï‚', desc: 'ÎœÎµÏ„ÏÎ¬ Ï…Î³ÏÎ±ÏƒÎ¯Î±', type: 'sensor', unit: '%' },
                { id: 'motion-sensor', icon: 'ğŸ‘ï¸', name: 'Î‘Î½Î¹Ï‡Î½ÎµÏ…Ï„Î®Ï‚ ÎšÎ¯Î½Î·ÏƒÎ·Ï‚', desc: 'Î•Î½Ï„Î¿Ï€Î¯Î¶ÎµÎ¹ ÎºÎ¯Î½Î·ÏƒÎ·', type: 'sensor', unit: '' },
                { id: 'plc', icon: 'ğŸ–¥ï¸', name: 'Î•Î»ÎµÎ³ÎºÏ„Î®Ï‚ PLC', desc: 'Siemens S7-1200', type: 'controller', unit: '' },
                { id: 'gateway', icon: 'ğŸ“¡', name: 'Î ÏÎ»Î· IoT', desc: 'MQTT/Modbus', type: 'gateway', unit: '' },
                { id: 'motor', icon: 'âš™ï¸', name: 'ÎšÎ¹Î½Î·Ï„Î®ÏÎ±Ï‚', desc: 'ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÎºÎ¯Î½Î·ÏƒÎ·Ï‚', type: 'actuator', unit: 'RPM' },
                { id: 'valve', icon: 'ğŸ”§', name: 'Î’Î±Î»Î²Î¯Î´Î±', desc: 'ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÏÎ¿Î®Ï‚', type: 'actuator', unit: '%' },
                { id: 'alarm', icon: 'ğŸš¨', name: 'Î£Ï…Î½Î±Î³ÎµÏÎ¼ÏŒÏ‚', desc: 'Î•Î¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹Ï‚', type: 'output', unit: '' }
            ]
        };

        // ==================== SCENARIO DEFINITIONS ====================
        const scenarios = {
            warehouse: [
                { type: 'plc', x: 300, y: 200 },
                { type: 'temp-sensor', x: 100, y: 150 },
                { type: 'humidity-sensor', x: 100, y: 250 },
                { type: 'gateway', x: 500, y: 200 }
            ],
            temperature: [
                { type: 'temp-sensor', x: 100, y: 180 },
                { type: 'plc', x: 300, y: 180 },
                { type: 'motor', x: 500, y: 120 },
                { type: 'alarm', x: 500, y: 240 }
            ],
            inventory: [
                { type: 'motion-sensor', x: 100, y: 150 },
                { type: 'plc', x: 300, y: 150 },
                { type: 'gateway', x: 500, y: 150 },
                { type: 'alarm', x: 300, y: 280 }
            ]
        };

        // ==================== TRANSLATIONS ====================
        const translations = {
            en: {
                headerTitle: 'IoT Builder',
                langText: 'Î•Î»Î»Î·Î½Î¹ÎºÎ¬',
                authBtnText: 'Sign In',
                logoutText: 'Logout',
                componentsTitle: 'Components',
                workspaceTitle: 'Workspace',
                simulateBtnText: 'Start',
                stopBtnText: 'Stop',
                clearBtnText: 'Clear',
                saveBtnText: 'Save',
                loadBtnText: 'Load',
                exportBtnText: 'Export PNG',
                statsTitle: 'Statistics',
                componentsLabel: 'COMPONENTS',
                connectionsLabel: 'CONNECTIONS',
                dataSecLabel: 'DATA/SEC',
                scenariosTitle: 'Scenarios',
                scenario1Name: 'Warehouse Monitor',
                scenario1Desc: 'PLC + Sensors + Gateway',
                scenario2Name: 'Temperature Control',
                scenario2Desc: 'Sensors + Actuators + Alarm',
                scenario3Name: 'Inventory Tracking',
                scenario3Desc: 'Motion + PLC + Gateway',
                placeholderText: 'Drag components here',
                statusText: 'Ready. Sign in to save projects.',
                authModalTitle: 'Authentication',
                loginTab: 'Login',
                signupTab: 'Sign Up',
                emailLabel1: 'Email',
                emailLabel2: 'Email',
                passwordLabel1: 'Password',
                passwordLabel2: 'Password',
                fullNameLabel: 'Full Name',
                loginSubmitText: 'Login',
                signupSubmitText: 'Create Account',
                saveModalTitle: 'Save Project',
                projectNameLabel: 'Project Name',
                projectDescLabel: 'Description (optional)',
                saveCancelText: 'Cancel',
                saveConfirmText: 'Save',
                loadModalTitle: 'Load Project',
                adminRole: 'ADMIN',
                userRole: 'USER',
                loadBtnTextShort: 'Load',
                deleteBtnText: 'Delete'
            },
            gr: {
                headerTitle: 'IoT Builder',
                langText: 'English',
                authBtnText: 'Î£ÏÎ½Î´ÎµÏƒÎ·',
                logoutText: 'Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·',
                componentsTitle: 'Î•Î¾Î±ÏÏ„Î®Î¼Î±Ï„Î±',
                workspaceTitle: 'Î§ÏÏÎ¿Ï‚ Î•ÏÎ³Î±ÏƒÎ¯Î±Ï‚',
                simulateBtnText: 'ÎˆÎ½Î±ÏÎ¾Î·',
                stopBtnText: 'Î”Î¹Î±ÎºÎ¿Ï€Î®',
                clearBtnText: 'ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚',
                saveBtnText: 'Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·',
                loadBtnText: 'Î¦ÏŒÏÏ„Ï‰ÏƒÎ·',
                exportBtnText: 'Î•Î¾Î±Î³Ï‰Î³Î® PNG',
                statsTitle: 'Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬',
                componentsLabel: 'Î•ÎÎ‘Î¡Î¤Î—ÎœÎ‘Î¤Î‘',
                connectionsLabel: 'Î£Î¥ÎÎ”Î•Î£Î•Î™Î£',
                dataSecLabel: 'Î”Î•Î”ÎŸÎœÎ•ÎÎ‘/Î”Î•Î¥',
                scenariosTitle: 'Î£ÎµÎ½Î¬ÏÎ¹Î±',
                scenario1Name: 'Î Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ· Î‘Ï€Î¿Î¸Î®ÎºÎ·Ï‚',
                scenario1Desc: 'PLC + Î‘Î¹ÏƒÎ¸Î·Ï„Î®ÏÎµÏ‚ + Î ÏÎ»Î·',
                scenario2Name: 'ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î˜ÎµÏÎ¼Î¿ÎºÏÎ±ÏƒÎ¯Î±Ï‚',
                scenario2Desc: 'Î‘Î¹ÏƒÎ¸Î·Ï„Î®ÏÎµÏ‚ + Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Ï„Î­Ï‚ + Î£Ï…Î½Î±Î³ÎµÏÎ¼ÏŒÏ‚',
                scenario3Name: 'Î Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ· Î‘Ï€Î¿Î¸Î­Î¼Î±Ï„Î¿Ï‚',
                scenario3Desc: 'ÎšÎ¯Î½Î·ÏƒÎ· + PLC + Î ÏÎ»Î·',
                placeholderText: 'Î£ÏÏÎµÏ„Îµ ÎµÎ¾Î±ÏÏ„Î®Î¼Î±Ï„Î± ÎµÎ´Ï',
                statusText: 'ÎˆÏ„Î¿Î¹Î¼Î¿. Î£Ï…Î½Î´ÎµÎ¸ÎµÎ¯Ï„Îµ Î³Î¹Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·.',
                authModalTitle: 'Î Î¹ÏƒÏ„Î¿Ï€Î¿Î¯Î·ÏƒÎ·',
                loginTab: 'Î£ÏÎ½Î´ÎµÏƒÎ·',
                signupTab: 'Î•Î³Î³ÏÎ±Ï†Î®',
                emailLabel1: 'Email',
                emailLabel2: 'Email',
                passwordLabel1: 'ÎšÏ‰Î´Î¹ÎºÏŒÏ‚',
                passwordLabel2: 'ÎšÏ‰Î´Î¹ÎºÏŒÏ‚',
                fullNameLabel: 'ÎŸÎ½Î¿Î¼Î±Ï„ÎµÏ€ÏÎ½Ï…Î¼Î¿',
                loginSubmitText: 'Î£ÏÎ½Î´ÎµÏƒÎ·',
                signupSubmitText: 'Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï',
                saveModalTitle: 'Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ÎˆÏÎ³Î¿Ï…',
                projectNameLabel: 'ÎŒÎ½Î¿Î¼Î± ÎˆÏÎ³Î¿Ï…',
                projectDescLabel: 'Î ÎµÏÎ¹Î³ÏÎ±Ï†Î® (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ®)',
                saveCancelText: 'Î‘ÎºÏÏÏ‰ÏƒÎ·',
                saveConfirmText: 'Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·',
                loadModalTitle: 'Î¦ÏŒÏÏ„Ï‰ÏƒÎ· ÎˆÏÎ³Î¿Ï…',
                adminRole: 'Î”Î™Î‘Î§Î•Î™Î¡Î™Î£Î¤Î—Î£',
                userRole: 'Î§Î¡Î—Î£Î¤Î—Î£',
                loadBtnTextShort: 'Î¦ÏŒÏÏ„Ï‰ÏƒÎ·',
                deleteBtnText: 'Î”Î¹Î±Î³ÏÎ±Ï†Î®'
            }
        };

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            renderComponents();
            updateStats();
        });

        function checkAuth() {
            const token = localStorage.getItem('iot_token');
            const user = localStorage.getItem('iot_user');
            
            if (token && user) {
                authToken = token;
                currentUser = JSON.parse(user);
                updateUIForLoggedIn();
            }
        }

        function updateUIForLoggedIn() {
            document.getElementById('authBtn').style.display = 'none';
            document.getElementById('userSection').style.display = 'block';
            document.getElementById('userEmail').textContent = currentUser.email;
            
            const roleText = currentUser.is_admin ? translations[currentLang].adminRole : translations[currentLang].userRole;
            document.getElementById('userRole').textContent = roleText;
            
            updateStatusMessage();
        }

        function updateUIForLoggedOut() {
            document.getElementById('authBtn').style.display = 'flex';
            document.getElementById('userSection').style.display = 'none';
            currentUser = null;
            authToken = null;
            updateStatusMessage();
        }

        function updateStatusMessage() {
            const msg = document.getElementById('statusMessage');
            const t = translations[currentLang];
            
            if (!currentUser) {
                msg.innerHTML = `<span id="statusText">${t.statusText}</span>`;
            } else if (simulationRunning) {
                msg.innerHTML = `<span style="color: #10b981;">â— Simulation running...</span>`;
            } else {
                msg.innerHTML = `<span style="color: #06b6d4;">â— Ready</span>`;
            }
        }

        // ==================== LANGUAGE SWITCHING ====================
        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'gr' : 'en';
            applyTranslations();
            renderComponents();
            
            // Update placed components
            placedComponents.forEach(comp => {
                const compData = componentTypes[currentLang].find(c => c.id === comp.componentId);
                if (compData) {
                    comp.name = compData.name;
                    const element = document.getElementById(comp.id);
                    if (element) {
                        element.querySelector('.placed-name').textContent = compData.name;
                    }
                }
            });
        }

        function applyTranslations() {
            const t = translations[currentLang];
            
            document.getElementById('headerTitle').textContent = t.headerTitle;
            document.getElementById('langText').textContent = t.langText;
            document.getElementById('authBtnText').textContent = t.authBtnText;
            if (document.getElementById('logoutText')) document.getElementById('logoutText').textContent = t.logoutText;
            document.getElementById('componentsTitle').textContent = t.componentsTitle;
            document.getElementById('workspaceTitle').textContent = t.workspaceTitle;
            document.getElementById('simulateBtnText').textContent = t.simulateBtnText;
            if (document.getElementById('stopBtnText')) document.getElementById('stopBtnText').textContent = t.stopBtnText;
            document.getElementById('clearBtnText').textContent = t.clearBtnText;
            document.getElementById('saveBtnText').textContent = t.saveBtnText;
            document.getElementById('loadBtnText').textContent = t.loadBtnText;
            document.getElementById('exportBtnText').textContent = t.exportBtnText;
            document.getElementById('statsTitle').textContent = t.statsTitle;
            document.getElementById('componentsLabel').textContent = t.componentsLabel;
            document.getElementById('connectionsLabel').textContent = t.connectionsLabel;
            document.getElementById('dataSecLabel').textContent = t.dataSecLabel;
            document.getElementById('scenariosTitle').textContent = t.scenariosTitle;
            document.getElementById('scenario1Name').textContent = t.scenario1Name;
            document.getElementById('scenario1Desc').textContent = t.scenario1Desc;
            document.getElementById('scenario2Name').textContent = t.scenario2Name;
            document.getElementById('scenario2Desc').textContent = t.scenario2Desc;
            document.getElementById('scenario3Name').textContent = t.scenario3Name;
            document.getElementById('scenario3Desc').textContent = t.scenario3Desc;
            document.getElementById('placeholderText').textContent = t.placeholderText;
            document.getElementById('authModalTitle').textContent = t.authModalTitle;
            document.getElementById('loginTab').textContent = t.loginTab;
            document.getElementById('signupTab').textContent = t.signupTab;
            document.getElementById('emailLabel1').textContent = t.emailLabel1;
            document.getElementById('emailLabel2').textContent = t.emailLabel2;
            document.getElementById('passwordLabel1').textContent = t.passwordLabel1;
            document.getElementById('passwordLabel2').textContent = t.passwordLabel2;
            document.getElementById('fullNameLabel').textContent = t.fullNameLabel;
            document.getElementById('loginSubmitText').textContent = t.loginSubmitText;
            document.getElementById('signupSubmitText').textContent = t.signupSubmitText;
            document.getElementById('saveModalTitle').textContent = t.saveModalTitle;
            document.getElementById('projectNameLabel').textContent = t.projectNameLabel;
            document.getElementById('projectDescLabel').textContent = t.projectDescLabel;
            document.getElementById('saveCancelText').textContent = t.saveCancelText;
            document.getElementById('saveConfirmText').textContent = t.saveConfirmText;
            document.getElementById('loadModalTitle').textContent = t.loadModalTitle;
            
            if (currentUser) {
                const roleText = currentUser.is_admin ? t.adminRole : t.userRole;
                document.getElementById('userRole').textContent = roleText;
            }
            
            updateStatusMessage();
        }

        // ==================== COMPONENTS RENDERING ====================
        function renderComponents() {
            const library = document.getElementById('componentLibrary');
            library.innerHTML = '';
            
            componentTypes[currentLang].forEach(comp => {
                const div = document.createElement('div');
                div.className = 'component-item';
                div.draggable = true;
                div.dataset.componentId = comp.id;
                
                div.innerHTML = `
                    <div class="component-icon">${comp.icon}</div>
                    <div class="component-info">
                        <div class="component-name">${comp.name}</div>
                        <div class="component-desc">${comp.desc}</div>
                    </div>
                `;
                
                div.addEventListener('dragstart', drag);
                library.appendChild(div);
            });
        }

        // ==================== DRAG & DROP ====================
        function drag(ev) {
            ev.dataTransfer.setData('componentId', ev.target.closest('.component-item').dataset.componentId);
        }

        function allowDrop(ev) {
            ev.preventDefault();
            document.getElementById('canvas').classList.add('drag-over');
        }

        function drop(ev) {
            ev.preventDefault();
            const canvas = document.getElementById('canvas');
            canvas.classList.remove('drag-over');
            
            const componentId = ev.dataTransfer.getData('componentId');
            const compData = componentTypes[currentLang].find(c => c.id === componentId);
            
            if (!compData) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = ev.clientX - rect.left + canvas.scrollLeft - 65;
            const y = ev.clientY - rect.top + canvas.scrollTop - 65;
            
            addComponent(compData, x, y);
            
            // Hide placeholder
            document.getElementById('canvasPlaceholder').style.display = 'none';
        }

        function addComponent(compData, x, y) {
            const id = 'comp-' + (++componentCounter);
            
            const component = {
                id: id,
                componentId: compData.id,
                name: compData.name,
                icon: compData.icon,
                type: compData.type,
                unit: compData.unit,
                x: x,
                y: y,
                value: getInitialValue(compData)
            };
            
            placedComponents.push(component);
            renderPlacedComponent(component);
            updateStats();
        }

        function getInitialValue(compData) {
            switch (compData.type) {
                case 'sensor':
                    if (compData.id === 'temp-sensor') return '22';
                    if (compData.id === 'humidity-sensor') return '45';
                    if (compData.id === 'motion-sensor') return 'OFF';
                    return '0';
                case 'actuator':
                    return '0';
                case 'controller':
                case 'gateway':
                case 'output':
                    return 'IDLE';
                default:
                    return '--';
            }
        }

        function renderPlacedComponent(component) {
            const canvas = document.getElementById('canvas');
            
            const div = document.createElement('div');
            div.className = 'placed-component';
            div.id = component.id;
            div.style.left = component.x + 'px';
            div.style.top = component.y + 'px';
            
            div.innerHTML = `
                <button class="component-remove" onclick="removeComponent('${component.id}')">Ã—</button>
                <div class="placed-icon">${component.icon}</div>
                <div class="placed-name">${component.name}</div>
                <div class="placed-value">${component.value}${component.unit}</div>
            `;
            
            makeDraggable(div);
            canvas.appendChild(div);
        }

        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            element.onmousedown = dragMouseDown;
            
            function dragMouseDown(e) {
                if (e.target.classList.contains('component-remove')) return;
                
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }
            
            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                const newTop = element.offsetTop - pos2;
                const newLeft = element.offsetLeft - pos1;
                
                element.style.top = Math.max(0, newTop) + 'px';
                element.style.left = Math.max(0, newLeft) + 'px';
                
                // Update position in array
                const comp = placedComponents.find(c => c.id === element.id);
                if (comp) {
                    comp.x = element.offsetLeft;
                    comp.y = element.offsetTop;
                }
            }
            
            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        function removeComponent(id) {
            const element = document.getElementById(id);
            if (element) element.remove();
            
            placedComponents = placedComponents.filter(c => c.id !== id);
            updateStats();
            
            if (placedComponents.length === 0) {
                document.getElementById('canvasPlaceholder').style.display = 'block';
            }
        }

        function clearCanvas() {
            if (placedComponents.length === 0) return;
            
            const msg = currentLang === 'en' ? 
                'Clear all components?' : 
                'ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ ÎµÎ¾Î±ÏÏ„Î·Î¼Î¬Ï„Ï‰Î½;';
            
            if (!confirm(msg)) return;
            
            placedComponents = [];
            document.getElementById('canvas').innerHTML = '<div class="canvas-placeholder" id="canvasPlaceholder"><div class="canvas-placeholder-icon">ğŸ¯</div><div class="canvas-placeholder-text" id="placeholderText">' + translations[currentLang].placeholderText + '</div></div>';
            updateStats();
            
            if (simulationRunning) {
                toggleSimulation();
            }
        }

        // ==================== SIMULATION ====================
        function toggleSimulation() {
            if (placedComponents.length === 0) {
                showAlert(currentLang === 'en' ? 'Add components first' : 'Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ ÎµÎ¾Î±ÏÏ„Î®Î¼Î±Ï„Î± Ï€ÏÏÏ„Î±', 'warning');
                return;
            }
            
            simulationRunning = !simulationRunning;
            
            const startBtn = document.getElementById('simulateBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            if (simulationRunning) {
                startBtn.style.display = 'none';
                stopBtn.style.display = 'flex';
                simulationInterval = setInterval(updateSimulation, 1500);
            } else {
                startBtn.style.display = 'flex';
                stopBtn.style.display = 'none';
                if (simulationInterval) {
                    clearInterval(simulationInterval);
                    simulationInterval = null;
                }
                dataPerSec = 0;
                document.getElementById('dataSecCount').textContent = '0';
            }
            
            updateStatusMessage();
        }

        function updateSimulation() {
            let dataPoints = 0;
            
            placedComponents.forEach(comp => {
                const element = document.getElementById(comp.id);
                if (!element) return;
                
                element.classList.add('active');
                
                // Update value based on component type
                if (comp.type === 'sensor') {
                    if (comp.componentId === 'temp-sensor') {
                        comp.value = (18 + Math.random() * 10).toFixed(1);
                        dataPoints++;
                    } else if (comp.componentId === 'humidity-sensor') {
                        comp.value = (35 + Math.random() * 30).toFixed(0);
                        dataPoints++;
                    } else if (comp.componentId === 'motion-sensor') {
                        comp.value = Math.random() > 0.6 ? 'ON' : 'OFF';
                        dataPoints++;
                    }
                } else if (comp.type === 'actuator') {
                    comp.value = (Math.random() * 100).toFixed(0);
                    dataPoints++;
                } else if (comp.type === 'controller' || comp.type === 'gateway') {
                    comp.value = Math.random() > 0.2 ? 'ACTIVE' : 'IDLE';
                    dataPoints++;
                } else if (comp.type === 'output') {
                    comp.value = Math.random() > 0.8 ? 'ALERT' : 'OK';
                    dataPoints++;
                }
                
                const valueDiv = element.querySelector('.placed-value');
                if (valueDiv) {
                    valueDiv.textContent = comp.value + comp.unit;
                }
                
                setTimeout(() => {
                    element.classList.remove('active');
                }, 700);
            });
            
            dataPerSec = dataPoints;
            document.getElementById('dataSecCount').textContent = dataPerSec;
        }

        function updateStats() {
            document.getElementById('componentsCount').textContent = placedComponents.length;
            
            // Calculate connections (simplified: components - 1)
            const connections = Math.max(0, placedComponents.length - 1);
            document.getElementById('connectionsCount').textContent = connections;
        }

        // ==================== SCENARIOS ====================
        function loadScenario(type) {
            if (placedComponents.length > 0) {
                const msg = currentLang === 'en' ? 
                    'This will clear current components. Continue?' : 
                    'Î˜Î± Î´Î¹Î±Î³ÏÎ±Ï†Î¿ÏÎ½ Ï„Î± Ï„ÏÎ­Ï‡Î¿Î½Ï„Î± ÎµÎ¾Î±ÏÏ„Î®Î¼Î±Ï„Î±. Î£Ï…Î½Î­Ï‡ÎµÎ¹Î±;';
                
                if (!confirm(msg)) return;
            }
            
            clearCanvas();
            
            const scenarioComponents = scenarios[type];
            scenarioComponents.forEach(sc => {
                const compData = componentTypes[currentLang].find(c => c.id === sc.type);
                if (compData) {
                    addComponent(compData, sc.x, sc.y);
                }
            });
        }

        // ==================== AUTHENTICATION ====================
        function openAuthModal() {
            document.getElementById('authModal').classList.add('active');
            document.getElementById('authAlert').innerHTML = '';
        }

        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.getElementById('loginTab').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.getElementById('signupTab').classList.add('active');
                document.getElementById('signupForm').classList.add('active');
            }
            
            document.getElementById('authAlert').innerHTML = '';
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAuthAlert('Please fill all fields', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `username=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.access_token;
                    currentUser = data.user;
                    
                    localStorage.setItem('iot_token', authToken);
                    localStorage.setItem('iot_user', JSON.stringify(currentUser));
                    
                    updateUIForLoggedIn();
                    closeAuthModal();
                    
                    showAlert(currentLang === 'en' ? 'Login successful!' : 'Î•Ï€Î¹Ï„Ï…Ï‡Î®Ï‚ ÏƒÏÎ½Î´ÎµÏƒÎ·!', 'success');
                } else {
                    showAuthAlert(data.detail || 'Login failed', 'error');
                }
            } catch (error) {
                showAuthAlert('Connection error. Please try again.', 'error');
                console.error('Login error:', error);
            }
        }

        async function handleSignup() {
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const fullName = document.getElementById('signupFullName').value.trim();
            
            if (!email || !password || !fullName) {
                showAuthAlert('Please fill all fields', 'error');
                return;
            }
            
            if (password.length < 6) {
                showAuthAlert('Password must be at least 6 characters', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, full_name: fullName })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAuthAlert(currentLang === 'en' ? 'Account created! Please login.' : 'Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ! Î£Ï…Î½Î´ÎµÎ¸ÎµÎ¯Ï„Îµ.', 'success');
                    setTimeout(() => {
                        switchAuthTab('login');
                        document.getElementById('loginEmail').value = email;
                    }, 1500);
                } else {
                    showAuthAlert(data.detail || 'Registration failed', 'error');
                }
            } catch (error) {
                showAuthAlert('Connection error. Please try again.', 'error');
                console.error('Signup error:', error);
            }
        }

        function logout() {
            localStorage.removeItem('iot_token');
            localStorage.removeItem('iot_user');
            
            updateUIForLoggedOut();
            clearCanvas();
            
            showAlert(currentLang === 'en' ? 'Logged out successfully' : 'Î‘Ï€Î¿ÏƒÏ…Î½Î´ÎµÎ¸Î®ÎºÎ±Ï„Îµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚', 'info');
        }

        function showAuthAlert(message, type) {
            const alert = document.getElementById('authAlert');
            alert.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '80px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '300px';
            alertDiv.style.animation = 'slideIn 0.3s ease';
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => alertDiv.remove(), 300);
            }, 3000);
        }

        // ==================== PROJECT MANAGEMENT ====================
        function openSaveModal() {
            if (!authToken) {
                showAlert(currentLang === 'en' ? 'Please login to save projects' : 'Î£Ï…Î½Î´ÎµÎ¸ÎµÎ¯Ï„Îµ Î³Î¹Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·', 'warning');
                openAuthModal();
                return;
            }
            
            if (placedComponents.length === 0) {
                showAlert(currentLang === 'en' ? 'Add components first' : 'Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ ÎµÎ¾Î±ÏÏ„Î®Î¼Î±Ï„Î± Ï€ÏÏÏ„Î±', 'warning');
                return;
            }
            
            document.getElementById('saveModal').classList.add('active');
            document.getElementById('saveAlert').innerHTML = '';
            document.getElementById('projectName').value = '';
            document.getElementById('projectDesc').value = '';
        }

        function closeSaveModal() {
            document.getElementById('saveModal').classList.remove('active');
        }

        async function saveProject() {
            const name = document.getElementById('projectName').value.trim();
            const description = document.getElementById('projectDesc').value.trim();
            
            if (!name) {
                showSaveAlert(currentLang === 'en' ? 'Please enter a project name' : 'Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ ÏŒÎ½Î¿Î¼Î± Î­ÏÎ³Î¿Ï…', 'error');
                return;
            }
            
            const projectData = {
                components: placedComponents.map(c => ({
                    componentId: c.componentId,
                    x: c.x,
                    y: c.y
                }))
            };
            
            try {
                // Check project limit for non-admin users
                if (!currentUser.is_admin) {
                    const projectsResponse = await fetch(`${API_URL}/projects`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const projects = await projectsResponse.json();
                    
                    if (projects.length >= 3) {
                        showSaveAlert(currentLang === 'en' ? 
                            'You can only save up to 3 projects. Delete one first.' : 
                            'ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏƒÎµÏ„Îµ Î¼Î­Ï‡ÏÎ¹ 3 Î­ÏÎ³Î±. Î”Î¹Î±Î³ÏÎ¬ÏˆÏ„Îµ Î­Î½Î± Ï€ÏÏÏ„Î±.', 'warning');
                        return;
                    }
                }
                
                const response = await fetch(`${API_URL}/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        name,
                        description,
                        data: projectData
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentProjectId = data.id;
                    showSaveAlert(currentLang === 'en' ? 'Project saved successfully!' : 'Î¤Î¿ Î­ÏÎ³Î¿ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ!', 'success');
                    setTimeout(() => {
                        closeSaveModal();
                    }, 1500);
                } else {
                    showSaveAlert(data.detail || 'Failed to save project', 'error');
                }
            } catch (error) {
                showSaveAlert('Connection error. Please try again.', 'error');
                console.error('Save error:', error);
            }
        }

        function showSaveAlert(message, type) {
            const alert = document.getElementById('saveAlert');
            alert.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }

        async function openLoadModal() {
            if (!authToken) {
                showAlert(currentLang === 'en' ? 'Please login to load projects' : 'Î£Ï…Î½Î´ÎµÎ¸ÎµÎ¯Ï„Îµ Î³Î¹Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·', 'warning');
                openAuthModal();
                return;
            }
            
            document.getElementById('loadModal').classList.add('active');
            document.getElementById('loadAlert').innerHTML = `<div class="alert alert-info">${currentLang === 'en' ? 'Loading projects...' : 'Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î­ÏÎ³Ï‰Î½...'}</div>`;
            
            try {
                const response = await fetch(`${API_URL}/projects`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const projects = await response.json();
                
                if (response.ok) {
                    renderProjectList(projects);
                } else {
                    showLoadAlert('Failed to load projects', 'error');
                }
            } catch (error) {
                showLoadAlert('Connection error. Please try again.', 'error');
                console.error('Load error:', error);
            }
        }

        function closeLoadModal() {
            document.getElementById('loadModal').classList.remove('active');
        }

        function renderProjectList(projects) {
            const listDiv = document.getElementById('projectList');
            const t = translations[currentLang];
            
            if (projects.length === 0) {
                listDiv.innerHTML = `<div class="alert alert-info">${currentLang === 'en' ? 'No saved projects' : 'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Î± Î­ÏÎ³Î±'}</div>`;
                document.getElementById('loadAlert').innerHTML = '';
                return;
            }
            
            listDiv.innerHTML = projects.map(p => {
                const date = new Date(p.updated_at).toLocaleDateString();
                const compCount = p.data.components ? p.data.components.length : 0;
                
                return `
                    <div class="project-item">
                        <div class="project-header">
                            <div class="project-name">${p.name}</div>
                            <div class="project-actions">
                                <button class="btn btn-cyan" onclick="loadProjectData(${p.id})">
                                    ${t.loadBtnTextShort}
                                </button>
                                <button class="btn btn-pink" onclick="deleteProject(${p.id})">
                                    ${t.deleteBtnText}
                                </button>
                            </div>
                        </div>
                        ${p.description ? `<div class="project-desc">${p.description}</div>` : ''}
                        <div class="project-meta">
                            <span>ğŸ“¦ ${compCount} components</span>
                            <span>ğŸ“… ${date}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('loadAlert').innerHTML = '';
        }

        async function loadProjectData(projectId) {
            try {
                const response = await fetch(`${API_URL}/projects/${projectId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const project = await response.json();
                
                if (response.ok) {
                    clearCanvas();
                    currentProjectId = projectId;
                    
                    if (project.data && project.data.components) {
                        project.data.components.forEach(comp => {
                            const compData = componentTypes[currentLang].find(c => c.id === comp.componentId);
                            if (compData) {
                                addComponent(compData, comp.x, comp.y);
                            }
                        });
                    }
                    
                    closeLoadModal();
                    showAlert(currentLang === 'en' ? 'Project loaded!' : 'Î¤Î¿ Î­ÏÎ³Î¿ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ!', 'success');
                } else {
                    showLoadAlert('Failed to load project', 'error');
                }
            } catch (error) {
                showLoadAlert('Connection error. Please try again.', 'error');
                console.error('Load project error:', error);
            }
        }

        async function deleteProject(projectId) {
            const msg = currentLang === 'en' ? 
                'Delete this project?' : 
                'Î”Î¹Î±Î³ÏÎ±Ï†Î® Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… Î­ÏÎ³Î¿Ï…;';
            
            if (!confirm(msg)) return;
            
            try {
                const response = await fetch(`${API_URL}/projects/${projectId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    showAlert(currentLang === 'en' ? 'Project deleted' : 'Î¤Î¿ Î­ÏÎ³Î¿ Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ', 'success');
                    openLoadModal(); // Refresh list
                } else {
                    showLoadAlert('Failed to delete project', 'error');
                }
            } catch (error) {
                showLoadAlert('Connection error. Please try again.', 'error');
                console.error('Delete error:', error);
            }
        }

        function showLoadAlert(message, type) {
            const alert = document.getElementById('loadAlert');
            alert.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }

        // ==================== PNG EXPORT ====================
        async function exportToPNG() {
            if (placedComponents.length === 0) {
                showAlert(currentLang === 'en' ? 'Add components first' : 'Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ ÎµÎ¾Î±ÏÏ„Î®Î¼Î±Ï„Î± Ï€ÏÏÏ„Î±', 'warning');
                return;
            }
            
            const canvas = document.getElementById('canvas');
            
            try {
                const canvasEl = await html2canvas(canvas, {
                    backgroundColor: '#0f1923',
                    scale: 2
                });
                
                const link = document.createElement('a');
                link.download = 'iot-setup-' + Date.now() + '.png';
                link.href = canvasEl.toDataURL();
                link.click();
                
                showAlert(currentLang === 'en' ? 'PNG exported!' : 'PNG ÎµÎ¾Î®Ï‡Î¸Î·!', 'success');
            } catch (error) {
                showAlert('Export failed. Please try again.', 'error');
                console.error('Export error:', error);
            }
        }
    </script>
</body>
</html>
